---
title: "Metabolomics OSCA analyses"
author: "Chloe Yap"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  epuRate::PCTG:
    toc: TRUE
    number_sections: FALSE
    code_folding: "hide"
knit: (function(inputFile, encoding) { 
          rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file='metabolomics_osca_analysis_INT.html') })
---

# Basic info

**Nomenclature**

- Description: https://www.caymanchem.com/news/sphingolipid-shorthand
- Official: https://www.qmul.ac.uk/sbcs/iupac/
- Annotations:
    - HMDB: https://hmdb.ca/metabolites/HMDB0011211
    - Lipid Maps: https://www.lipidmaps.org/databases/lmsd/LMGP01030008?LMID=LMGP01030008

# Set-up

## Libraries

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# You need these libraries to run this template:
library(rmarkdown)    # install.packages("rmarkdown") 
library(epuRate)      # devtools::install_github("holtzy/epuRate", force=TRUE)
library(tidyverse)
library(data.table)
library(factoextra)
library(uwot)
library(ggplot2)
library(GGally)
library(ggforce)
library(corrplot)
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
library(caret)
library(DT)
library(vegan)
library(ComplexHeatmap)
library(colorspace)
library(MASS)
library(RColorBrewer)
library(ggrepel)

```

## Directories

```{r}

lipids_dir <- "~/Documents/Research/ASD/Data/5_metabolomics/Baker/2021_06_18_AUTISM_Data_Samples_only_Individual_lipids.csv"
lipids_class_dir <- "~/Documents/Research/ASD/Data/5_metabolomics/Baker/2021_06_18_AUTISM_Data_Samples_only_Total_lipids_class.csv"
batch_dir <- "~/Documents/Research/ASD/Data/5_metabolomics/Baker/2021_06_18_AUTISM_Data_Samples_only_Annotation_Batch.csv"
outliers_dir <- "~/Documents/Research/ASD/Data/5_metabolomics/Baker/2021_06_18_AUTISM_Data_Samples_only_Sample_outliers.csv"
outliers_lipids_dir <- "~/Documents/Research/ASD/Data/5_metabolomics/analysis/outliers_lipids_batch.id"
anno_dir <- "~/Documents/Research/ASD/Data/5_metabolomics/Baker/2021_06_18_AUTISM_Data_Samples_only_Annotation.csv"
pheno_aab_dir <- "~/Documents/Research/ASD/Data/Phenotype/extracted_pheno/cognitive_crossancestry_child.pheno"
pheno_aab_qtab_dir <- "~/Documents/Research/ASD/Data/Phenotype/extracted_pheno/AAB_QTAB_aggregated.pheno"
diet_raw_dir <- "~/Documents/Research/ASD/Data/Diet/AES_ACRC_QTAB/AES_ACRC_QTAB_diet_metabolomics.txt"
diet_pc_dir <- "~/Documents/Research/ASD/Data/Diet/AES_ACRC_QTAB/AES_ACRC_QTAB_diet_PC_metabolomics_264_pcenergy_PC13_clr_dietonly.csv"
##### ADD pePCs on new subset of data

```

## Read-in data

```{r}

lipids <- read.csv(lipids_dir, header = T, as.is = T)
lipids_class <- read.csv(lipids_class_dir, header = T, as.is = T)
batch <- read.csv(batch_dir, header = T, as.is = T)
outliers <- read.csv(outliers_dir, header = T, as.is = T)
outliers_lipids <- read.delim(outliers_lipids_dir, header = F, as.is = T)
anno <- read.csv(anno_dir, header = T, as.is = T)
anno_class.tmp <- read.csv(lipids_class_dir, header = F, as.is = T)
pheno_aab_full <- read.delim(pheno_aab_dir, header = T, as.is = T)
pheno_aab_qtab <- read.delim(pheno_aab_qtab_dir, header = T, as.is = T)
diet_raw <- read.delim(diet_raw_dir, header = T, as.is = T)
diet_pc <- read.csv(diet_pc_dir, header = T, as.is = T)

```

## Clean data

```{r}

pheno_full <- left_join(pheno_aab_qtab, pheno_aab_full)
pheno.tmp <- left_join(lipids[,1:2], pheno_full)
pheno <- pheno.tmp[order(match(pheno.tmp$IID, lipids$IID)),]
pheno <- left_join(pheno, batch, by = "RunID")

rm_oldpePC <- grep("diet_pe", colnames(pheno))
pheno <- pheno[,-rm_oldpePC]
pheno <- left_join(pheno, diet_pc, by = "IID")

micro_col <- c("fibre","thiamin","riboflavin","niacinequiv","vitc","folate","vita","retinol","betacarotine","sodium","potassium","magnesium","calcium","phosphorus","iron","zinc")
macro_col <- c("protein","fats","satfats","polyfats","monofats","cholesterol","carbohydrate","sugars")
pe_col <- c("peprotein", "pecarbohydrate", "pefats", "pesatfats", "pepolyfats", "pemonofats", "pealcohol", "pecore", "penoncore", "peveg", "pefruit", "pemeat", "pealt", "pegrains", "pedairy", "pesweet_drink", "pepack_snack", "peconfect", "pebaked_products", "petakeaway", "pecondiments", "pefatty_meats", "pefatty_meats", "pealcohol_bev", "pemisc")
arfs_col <- colnames(diet_raw)[grep("^arfs_", colnames(diet_raw))]
diet_derived <- diet_raw %>% dplyr::select(IID, all_of(c(micro_col, macro_col, pe_col, arfs_col)))
# diet_derived <- diet_raw %>% dplyr::select(IID, all_of(c(micro_col, macro_col, pe_col, arfs_col, "energy"))) # remove "energy" here as already in the pheno file
pheno <- left_join(pheno, diet_derived, by = "IID")

# Tidy up columns
pheno$iq_dq_wisccomp_mselnv_nih <- as.numeric(pheno$iq_dq_wisccomp_mselnv_nih)

identical(pheno$IID, lipids$IID)
identical(pheno$IID, lipids_class$IID)

# Add outliers column
pheno$outliers <- as.character(ifelse(pheno$IID %in% outliers$IID, pheno$IID, NA))

# Add adverse events column
adverse_event.id <- c(2202542, 4406321, 3304969, 2202511, 4406320, 4406272, 3392391, 4406348, 1101685, 1101639, 2202554, 3304926)
pheno$adverse_event <- ifelse(pheno$IID %in% adverse_event.id, pheno$IID, NA)

# Check that there are no cotwins in the dataset
qtabtwin <- c(258404, 258108, 258580, 258625, 258541, 258139, 258752, 258810, 258591, 258235, 258724, 258796, 258367, 258934, 258898, 258682, 258631, 258819, 258148, 258218, 258009, 258003, 258021, 25875)
qtabcotwin <- c(258403, 258175, 258823, 258505, 258046, 258348, 258826, 258093, 258639, 258757, 258634, 258872, 258561, 258536, 258794, 258820, 258429, 258181, 258569, 258294, 258495, 258804, 25883)
length(which(pheno$IID %in% qtabcotwin))

# Check coding
pheno$sex <- as.factor(pheno$sex)

# Add age^2
pheno$age2 <- pheno$age^2

# Add periodic functions for time of sample collection
# - based on eyeballing the lipid vs collection time graphs, it looksl ike the cosine transform generalises better across lipids
#pheno$collection_blood_time_sin <- sin((pheno$collection_blood_time/2400)*pi)
#plot(pheno$collection_blood_time, pheno$collection_blood_time_sin)
pheno$collection_blood_time_cos <- sin((pheno$collection_blood_time/2400)*2*pi)
plot(pheno$collection_blood_time, pheno$collection_blood_time_cos)

# Add ifnerred clinical lipids variables
identical(lipids$IID, lipids_class$IID)
identical(pheno$IID, lipids_class$IID)
pheno$cholesterol_lipidome <- lipids$COH + lipids_class$Total.CE
pheno$triglycerides_lipidome <- lipids_class$Total.TG.SIM.

# Make annotation column with matching format to headers
anno$Lipid.species_header <- gsub("[^[:alnum:] ]", ".", anno$Lipid.species)
anno$Lipid.species_header <- gsub(" ", ".", anno$Lipid.species_header)

# Make annotation file for lipids_class
anno_class <- data.frame(lipid = colnames(lipids_class)[3:ncol(lipids_class)], Lipid.species = as.vector(t(anno_class.tmp[1,3:ncol(anno_class.tmp)])), Lipid.species_header = colnames(lipids_class)[3:ncol(lipids_class)], Lipid.class = as.vector(t(anno_class.tmp[1,3:ncol(anno_class.tmp)])))
anno_class[] <- lapply(anno_class, as.character)

# Remove TG [NL] from classes and TG [SIM] from lipids
rm_lipids_class <- grep(".NL.", colnames(lipids_class))
rm_lipids <- grep(".SIM.", colnames(lipids))
lipids_class <- lipids_class[,-rm_lipids_class]
lipids <- lipids[,-rm_lipids]

# Lipid classes
rownames(lipids_class) <- lipids_class$IID
lipids_class.long <- melt(lipids_class, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_class.long <- left_join(lipids_class.long, pheno, by = "IID")
lipids_class.long <- left_join(lipids_class.long, anno_class, by = "lipid")

# Lipids
rownames(lipids) <- lipids$IID
colnames(lipids) <- gsub("[^[:alnum:] ]", ".", colnames(lipids))
lipids.long <- melt(lipids, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids.long <- left_join(lipids.long, pheno)
anno.tmp <- anno
colnames(anno.tmp)[which(colnames(anno.tmp) == "Lipid.species_header")] <- "lipid"
lipids.long <- left_join(lipids.long, anno.tmp, by = "lipid")

```

### Exclude participants

```{r}

# Keep back-ups
lipids_class_keepSMS <- lipids_class
lipids_keepSMS <- lipids
pheno_keepSMS <- pheno
lipids.long_keepSMS <- lipids.long

# Exclude participant
lipids_class <- lipids_class %>% filter(IID != 4494902)
lipids <- lipids %>% filter(IID != 4494902)
pheno <- pheno %>% filter(IID != 4494902)
lipids.long <- lipids.long %>% filter(IID != 4494902)
lipids_class.long <- lipids_class.long %>% filter(IID != 4494902)

# CHOOSE to remove outliers in the OSCA script
# Keep outliers
lipids_class_outliers <- lipids_class
lipids_outliers <- lipids
pheno_outliers <- pheno
lipids.long_outliers <- lipids.long

# Exclude outliers
outliers.id <- as.vector(outliers$IID)
lipids_class <- lipids_class %>% filter(!IID %in% outliers.id)
lipids <- lipids %>% filter(!IID %in% outliers.id)
pheno <- pheno %>% filter(!IID %in% outliers.id)
lipids.long <- lipids.long %>% filter(!IID %in% outliers.id)
lipids_class.long <- lipids_class.long %>% filter(!IID %in% outliers.id)

# rownames
rownames(lipids_class) <- lipids_class$IID
rownames(lipids) <- lipids$IID
rownames(pheno) <- lipids$IID

```

### Exclude lipids

```{r}

# Exclude outliers
outliers_lipids.id <- as.vector(outliers_lipids$V1)
#lipids_class <- lipids_class %>% select(-all_of(outliers_lipids.id))
lipids <- lipids %>% dplyr::select(-all_of(outliers_lipids.id))
lipids.long <- lipids.long %>% filter(!lipid %in% all_of(outliers_lipids.id))
lipids_class.long <- lipids_class.long %>% filter(!lipid %in% all_of(outliers_lipids.id))

```

## Analysis-specific set-up

### Standardise

**Outliers from Baker already removed**

```{r}

# Apply standardisation
tmp <- apply(lipids_class[,3:ncol(lipids_class)], 2, function(x) (x - mean(x))/sd(x))
lipids_class_std <- data.frame(RunID = lipids_class$RunID, IID = lipids_class$IID, tmp)

tmp <- apply(lipids[,3:ncol(lipids)], 2, function(x) (x - mean(x))/sd(x))
lipids_std <- data.frame(RunID = lipids$RunID, IID = lipids$IID, tmp)

rownames(lipids_class_std) <- lipids_class_std$IID
lipids_class_std.long <- melt(lipids_class_std, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_class_std.long <- left_join(lipids_class_std.long, pheno, by = "IID")
lipids_class_std.long <- left_join(lipids_class_std.long, anno_class, by = "lipid")

rownames(lipids_std) <- lipids_std$IID
lipids_std.long <- melt(lipids_std, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_std.long <- left_join(lipids_std.long, pheno, by = "IID")
anno.tmp <- anno
colnames(anno.tmp)[which(colnames(anno.tmp) == "Lipid.species_header")] <- "lipid"
lipids_std.long <- left_join(lipids_std.long, anno.tmp, by = "lipid")

```

**Additionally remove outliers for storage time**

```{r}

# Remove outliers
outliers_storage.id <- pheno %>% filter(storage_blood_days > 2500) %>% pull(IID)
lipids_class_rmstorage <- lipids_class %>% filter(!IID %in% outliers_storage.id)
lipids_rmstorage <- lipids %>% filter(!IID %in% outliers_storage.id)

# Apply standardisation
tmp <- apply(lipids_class_rmstorage[,3:ncol(lipids_class_rmstorage)], 2, function(x) (x - mean(x))/sd(x))
lipids_class_rmstorage_std <- data.frame(RunID = lipids_class_rmstorage$RunID, IID = lipids_class_rmstorage$IID, tmp)

tmp <- apply(lipids_rmstorage[,3:ncol(lipids_rmstorage)], 2, function(x) (x - mean(x))/sd(x))
lipids_rmstorage_std <- data.frame(RunID = lipids_rmstorage$RunID, IID = lipids_rmstorage$IID, tmp)

rownames(lipids_class_rmstorage_std) <- lipids_class_rmstorage_std$IID
lipids_class_rmstorage_std.long <- melt(lipids_class_rmstorage_std, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_class_rmstorage_std.long <- left_join(lipids_class_rmstorage_std.long, pheno, by = "IID")
lipids_class_rmstorage_std.long <- left_join(lipids_class_rmstorage_std.long, anno_class, by = "lipid")

rownames(lipids_rmstorage_std) <- lipids_rmstorage_std$IID
lipids_rmstorage_std.long <- melt(lipids_rmstorage_std, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_rmstorage_std.long <- left_join(lipids_rmstorage_std.long, pheno, by = "IID")
anno.tmp <- anno
colnames(anno.tmp)[which(colnames(anno.tmp) == "Lipid.species_header")] <- "lipid"
lipids_rmstorage_std.long <- left_join(lipids_rmstorage_std.long, anno.tmp, by = "lipid")

```

### Inverse Normal Transform (INT)

**Outliers from Baker already removed**

```{r}

int <- function(x) {
  qnorm((rank(x,na.last="keep")-0.5)/sum(!is.na(x)))
}

lipids_class_int <- data.frame(RunID = lipids_class$RunID, IID = lipids_class$IID, apply(lipids_class[,3:ncol(lipids_class)], 2, int))

lipids_int <- data.frame(RunID = lipids$RunID, IID = lipids$IID, apply(lipids[,3:ncol(lipids)], 2, int))

rownames(lipids_class_int) <- lipids_class_int$IID
lipids_class_int.long <- melt(lipids_class_int, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_class_int.long <- left_join(lipids_class_int.long, pheno, by = "IID")
lipids_class_int.long <- left_join(lipids_class_int.long, anno_class, by = "lipid")

rownames(lipids_int) <- lipids_int$IID
lipids_int.long <- melt(lipids_int, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_int.long <- left_join(lipids_int.long, pheno, by = "IID")
anno.tmp <- anno
colnames(anno.tmp)[which(colnames(anno.tmp) == "Lipid.species_header")] <- "lipid"
lipids_int.long <- left_join(lipids_int.long, anno.tmp, by = "lipid")

```

**Additionally remove outliers for storage time**

```{r}

# Remove outliers
outliers_storage.id <- pheno %>% filter(storage_blood_days > 2500) %>% pull(IID)
lipids_class_rmstorage <- lipids_class %>% filter(!IID %in% outliers_storage.id)
lipids_rmstorage <- lipids %>% filter(!IID %in% outliers_storage.id)

# Apply standardisation
int <- function(x) {
  qnorm((rank(x,na.last="keep")-0.5)/sum(!is.na(x)))
}

lipids_class_rmstorage_int <- data.frame(RunID = lipids_class_rmstorage$RunID, IID = lipids_class_rmstorage$IID, apply(lipids_class_rmstorage[,3:ncol(lipids_class_rmstorage)], 2, int))

lipids_rmstorage_int <- data.frame(RunID = lipids_rmstorage$RunID, IID = lipids_rmstorage$IID, apply(lipids_rmstorage[,3:ncol(lipids_rmstorage)], 2, int))

rownames(lipids_class_rmstorage_int) <- lipids_class_rmstorage_int$IID
lipids_class_rmstorage_int.long <- melt(lipids_class_rmstorage_int, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_class_rmstorage_int.long <- left_join(lipids_class_rmstorage_int.long, pheno, by = "IID")
lipids_class_rmstorage_int.long <- left_join(lipids_class_rmstorage_int.long, anno_class, by = "lipid")

rownames(lipids_rmstorage) <- lipids_rmstorage$IID
lipids_rmstorage.long <- melt(lipids_rmstorage, id.vars = c("RunID", "IID"), variable.name = "lipid", value.name = "pmol_mL")
lipids_rmstorage.long <- left_join(lipids_rmstorage.long, pheno, by = "IID")
anno.tmp <- anno
colnames(anno.tmp)[which(colnames(anno.tmp) == "Lipid.species_header")] <- "lipid"
lipids_rmstorage.long <- left_join(lipids_rmstorage.long, anno.tmp, by = "lipid")

```

## Write data for OREML

### ORM data

```{r, eval = FALSE}

lipids_class_osca <- lipids_class_outliers[,c(2,2:ncol(lipids_class_outliers))]
lipids_osca <- lipids_outliers[,c(2,2:ncol(lipids_outliers))]

fwrite(lipids_class_osca, "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_class.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(lipids_osca, "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

```

**Standardise for OSCA (remove outliers)**

```{r, eval = FALSE}

fwrite(lipids_class_std[,c(2,2,3:ncol(lipids_class_std))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_class_std.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(lipids_std[,c(2,2,3:ncol(lipids_std))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_std.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

# Sensitivity analysis excluding storage time outliers
fwrite(lipids_class_rmstorage_std[,c(2,2,3:ncol(lipids_class_rmstorage_int))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_class_rmstoragepre_std.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(lipids_rmstorage_int[,c(2,2,3:ncol(lipids_rmstorage_int))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_rmstoragepre_std.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

```

**INT transform for OSCA (remove outliers)**

```{r, eval = FALSE}

fwrite(lipids_class_int[,c(2,2,3:ncol(lipids_class_int))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_class_int.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(lipids_int[,c(2,2,3:ncol(lipids_int))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_int.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

# Sensitivity analysis excluding storage time outliers
fwrite(lipids_class_rmstorage_int[,c(2,2,3:ncol(lipids_class_rmstorage_int))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_class_rmstoragepre_int.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(lipids_rmstorage_int[,c(2,2,3:ncol(lipids_rmstorage_int))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_rmstoragepre_int.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

```

#### Choose the desired transformation

```{r}

#transform_choice <- "none"
#transform_choice <- "std"
transform_choice <- "int"

if (transform_choice == "std") {
  
  lipids_class <- lipids_class_std
  lipids_class.long <- lipids_class_std.long
  lipids <- lipids_std
  lipids.long <- lipids_std.long
  
} else if (transform_choice == "int") {
  
  lipids_class <- lipids_class_int
  lipids_class.long <- lipids_class_int.long
  lipids <- lipids_int
  lipids.long <- lipids_int.long
  
}

```

### Pheno/covariate data

```{r, eval = FALSE}

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "ASD"))
fwrite(tmp[,c(1,1,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/asd.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age"))
fwrite(tmp[,c(1,1,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "sex")) %>% mutate(sex, sex = ifelse(sex == 2, 1, 0))
fwrite(tmp[,c(1,1,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/sex.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "bmi")) %>% filter(!is.na(bmi))
fwrite(tmp[,c(1,1,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/bmi.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "bmiz")) %>% filter(!is.na(bmiz))
fwrite(tmp[,c(1,1,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/bmiz.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "InjectionOrder"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "InjectionOrder", "storage_blood_days"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_storage.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "InjectionOrder", "storage_blood_days", "collection_blood_time_cos")) %>% filter(!is.na(collection_blood_time_cos))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_storage_time.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder", "storage_blood_days"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder", "storage_blood_days", "collection_blood_time_cos")) %>% filter(!is.na(collection_blood_time_cos))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage_time.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder", "storage_blood_days", "cholesterol_lipidome", "triglycerides_lipidome"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage_clinicallipids.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "InjectionOrder", "storage_blood_days"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order_storage.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "InjectionOrder", "storage_blood_days", "collection_blood_time_cos")) %>% filter(!is.na(collection_blood_time_cos))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order_storage_time.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "InjectionOrder", "storage_blood_days", "cholesterol_lipidome", "triglycerides_lipidome"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order_storage_clinicallipids.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% dplyr::select(c("IID", "age", "InjectionOrder", "storage_blood_days", "energy")) %>% filter(!is.na(energy))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_storage_energy.qcov", col.names = T, row.names = F, quote = F, sep = "\t") #

tmp <- pheno %>% dplyr::select(c("IID", "age", "InjectionOrder", "storage_blood_days", "collection_blood_time_cos", "energy")) %>% filter(!is.na(energy)) %>% filter(!is.na(collection_blood_time_cos))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_storage_time_energy_time.qcov", col.names = T, row.names = F, quote = F, sep = "\t") #

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder", "storage_blood_days")), diet_derived %>% dplyr::select(c("IID", "energy"))) %>% filter(!is.na(energy))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage_energy.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder", "storage_blood_days", "collection_blood_time_cos", "energy")) %>% filter(!is.na(energy)) %>% filter(!is.na(collection_blood_time_cos))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage_energy_time.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "storage_blood_days"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/storage.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_pc %>% dplyr::select(c("IID", "PC3_diet_pe")) %>% filter(!is.na(PC3_diet_pe))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/dietPC3.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "InjectionOrder", "storage_blood_days")), diet_pc %>% dplyr::select(c("IID", "PC3_diet_pe"))) %>% dplyr::select(c("IID", "age", "InjectionOrder"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_n263dietPC3.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder", "storage_blood_days")), diet_pc %>% dplyr::select(c("IID", "PC3_diet_pe"))) %>% dplyr::select(c("IID", "age", "InjectionOrder"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_n263dietPC3.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "InjectionOrder")), diet_pc %>% dplyr::select(c("IID", "PC3_diet_pe")))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_dietPC3.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder")), diet_pc %>% dplyr::select(c("IID", "PC3_diet_pe")))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_dietPC3.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "InjectionOrder")), diet_pc %>% dplyr::select(c("IID", "PC1_diet_pe", "PC2_diet_pe", "PC3_diet_pe")))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_dietPC123.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- inner_join(pheno %>% dplyr::select(c("IID", "age", "age2", "InjectionOrder")), diet_pc %>% dplyr::select(c("IID", "PC1_diet_pe", "PC2_diet_pe", "PC3_diet_pe")))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_dietPC123.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "InjectionOrder"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "Batch", "ASD"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/batch_asd.cov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "Batch", "sex"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/sex_batch.cov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "Batch"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/batch.cov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "Batch", "ASD"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/batch_asd.cov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "Batch", "sex", "ASD"))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/sex_batch_asd.cov", col.names = T, row.names = F, quote = F, sep = "\t")

#  %>% filter(IID != 4406427) as this ID has 0 in these fields
tmp <- diet_derived %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "protein")) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/protein.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "fats")) %>% filter(!is.na(fats)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/fats.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "carbohydrate")) %>% filter(!is.na(carbohydrate))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/carbohydrate.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "cholesterol")) %>% filter(!is.na(cholesterol)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/cholesterol.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "sugars")) %>% filter(!is.na(sugars))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/sugars.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_pc %>% dplyr::select(c("IID", "PC1_diet_pe")) %>% filter(!is.na(PC1_diet_pe))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/dietPC1.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_pc %>% dplyr::select(c("IID", "PC2_diet_pe")) %>% filter(!is.na(PC2_diet_pe))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/dietPC2.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_pc %>% dplyr::select(c("IID", "PC3_diet_pe")) %>% filter(!is.na(PC3_diet_pe))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/dietPC3.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% dplyr::select(c("IID", "shannon_food")) %>% filter(!is.na(shannon_food))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/dietdiversity.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol")) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% inner_join(., pheno %>% dplyr::select("IID", "age", "InjectionOrder")) %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "age", "InjectionOrder", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol")) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% inner_join(., pheno %>% dplyr::select("IID", "age", "age2", "InjectionOrder")) %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "age", "InjectionOrder", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol")) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% dplyr::select("IID", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol") %>% inner_join(., pheno %>% dplyr::select("IID", "age", "InjectionOrder", "storage_blood_days")) %>% filter(IID != 4494902) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_order_storage_macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% dplyr::select("IID", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol") %>% inner_join(., pheno %>% dplyr::select("IID", "age", "age2", "InjectionOrder", "storage_blood_days")) %>% filter(IID != 4494902) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage_macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% dplyr::select("IID", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol") %>% inner_join(., pheno %>% dplyr::select("IID", "InjectionOrder", "storage_blood_days")) %>% filter(IID != 4494902) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order_storage_macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- diet_derived %>% dplyr::select("IID", "protein", "monofats", "polyfats", "satfats", "carbohydrate", "cholesterol") %>% inner_join(., pheno %>% dplyr::select("IID", "InjectionOrder")) %>% filter(IID != 4494902) %>% filter(!is.na(protein)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order_macronutrients.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% dplyr::select("IID", "InjectionOrder", "storage_blood_days", "PC1_diet_pe", "PC2_diet_pe", "PC3_diet_pe") %>% filter(IID != 4494902) %>% filter(!is.na(PC1_diet_pe)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/order_storage_dietPC.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% dplyr::select("IID", "age", "age2", "InjectionOrder", "storage_blood_days", "PC1_diet_pe", "PC2_diet_pe", "PC3_diet_pe") %>% filter(IID != 4494902) %>% filter(!is.na(PC1_diet_pe)) %>% filter(IID != 4406427)
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/age_age2_order_storage_dietPC.qcov", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "sleep_cshq_total")) %>% filter(!is.na(sleep_cshq_total))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/sleep.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "iq_dq_wisccomp_mselnv_nih")) %>% filter(!is.na(iq_dq_wisccomp_mselnv_nih))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/iqdq.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "iq_dq_wisccomp_mselnv_nih")) %>% filter(!is.na(iq_dq_wisccomp_mselnv_nih)) %>% mutate(iq_dq_wisccomp_mselnv_nih, iq_dq_wisccomp_mselnv_nih = ifelse(iq_dq_wisccomp_mselnv_nih >= 70, 0, 1))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/iqdq01.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "vabs_gm_vscale")) %>% filter(!is.na(vabs_gm_vscale))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/vabsgm.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "vabs_gm_vscale")) %>% filter(!is.na(vabs_gm_vscale))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/vabsgm.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "vabs_ms_score")) %>% filter(!is.na(vabs_ms_score))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/vabsms.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "tanner_genital")) %>% filter(!is.na(tanner_genital))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/tannergenital.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(IID != 4494902) %>% dplyr::select(c("IID", "bristol_stool_chart")) %>% filter(!is.na(bristol_stool_chart))
fwrite(tmp[,c(1,1:ncol(tmp))], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/bristolstool.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

tmp <- pheno %>% filter(ASD %in% c(0,1)) %>% dplyr::select(c("IID", "ados2g_compar")) %>% filter(!is.na(ados2g_compar))
fwrite(tmp[,c(1,1,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/ados2g.pheno", col.names = T, row.names = F, quote = F, sep = "\t")

```

### Outliers

```{r}
outliers_storage <- data.frame(unique(c(pheno %>% filter(storage_blood_days >= 2500) %>% pull(IID), outliers.id)))
```

```{r}

fwrite(outliers[,c(2,2)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/outliers.id", col.names = T, row.names = F, quote = F, sep = "\t")

write.table(outliers_storage[,c(1,1)], "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/outliers_storage.id", col.names = T, row.names = F, quote = F, sep = "\t")

write.table(outliers_storage[,c(1,1)], "~/Documents/Research/ASD/Data/5_metabolomics/analysis/osca/data/outliers_storage.id", col.names = T, row.names = F, quote = F, sep = "\t")

```

## Plot ORMs

```{r}

# R script to read the GRM binary file
ReadORMBin=function(prefix, AllN=F, size=4){
  sum_i=function(i){
    return(sum(1:i))
  }
  BinFileName=paste(prefix,".orm.bin",sep="")
  NFileName=paste(prefix,".orm.N.bin",sep="")
  IDFileName=paste(prefix,".orm.id",sep="")
  id = read.table(IDFileName)
  n=dim(id)[1]
  BinFile=file(BinFileName, "rb");
  grm=readBin(BinFile, n=n*(n+1)/2, what=numeric(0), size=size)
  NFile=file(NFileName, "rb");
  if(AllN==T){
    N=readBin(NFile, n=n*(n+1)/2, what=numeric(0), size=size)
  }
  else N=readBin(NFile, n=1, what=numeric(0), size=size)
  i=sapply(1:n, sum_i)
  return(list(diag=grm[i], off=grm[-i], id=id, N=N))
}

```

```{r}

lipids_orm_int <- ReadORMBin("/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_int")

par(mfrow = c(1,2))
hist(lipids_orm_int$diag)
hist(lipids_orm_int$off)

lipids_orm_std <- ReadORMBin("/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_std")

par(mfrow = c(1,2))
hist(lipids_orm_std$diag)
hist(lipids_orm_std$off)

lipids_orm_raw <- ReadORMBin("/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids")

par(mfrow = c(1,2))
hist(lipids_orm_raw$diag)
hist(lipids_orm_raw$off)

# Look at dietary subset
lipids_orm_int_gz <- fread("/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_int.orm.gz")
lipids_orm_int_id <- fread("/Volumes/YAPASD-Q0851/uqcyap3/ASD/Data/5_metabolomics/analysis/osca/data/lipids_int.orm.id")

lipids_orm_int_diag <- lipids_orm_int_gz[which(lipids_orm_int_gz$V1 == lipids_orm_int_gz$V2)]
lipids_orm_int_off <- lipids_orm_int_gz[which(lipids_orm_int_gz$V1 != lipids_orm_int_gz$V2)]

diet_id <- which(lipids_orm_int_id$V1 %in% diet_derived$IID)
par(mfrow = c(1,2))
hist(lipids_orm_int_diag$V4[diet_id])
hist(lipids_orm_int_off$V4[diet_id])

```

## Handy annotation table

```{r}
datatable(anno)
```

# OREML results

```{r}

oreml = NULL

oreml_dir <- "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Output/5_metabolomics/analysis/osca/oreml"

```

## No covariates

```{r}

covn <- ""

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std"
} else if (transform_choice == "int") {
  orm <- "lipids_int"
}

```

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "bmiz", "sex", "protein", "fats", "carbohydrate", "sugars", "cholesterol", "bristolstool", "dietPC1", "dietPC2", "dietPC3", "dietdiversity")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

**ASD only: nocov, pre-remove storage duration outliers**

```{r}

pheno_ind <- "asd"
orm <- "lipids_int_rmstoragepre"
covn <- ""
rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_reml.rsq", sep = ""), fill = TRUE)
  
# Collect the V(O)/Vp estimate
tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
oreml <- rbind(oreml, tmp)

```

### Lipids class

```{r}

if (transform_choice == "none") {
  orm <- "lipids_class"
} else if (transform_choice == "std") {
  orm <- "lipids_class_std"
} else if (transform_choice == "int") {
  orm <- "lipids_class_int"
}

```

```{r}

pheno_name <- c("asd", "age")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Covariates: demographic + batch

- N.B. for age and dietary variables, I didn't include age as a covariate
- for dietary macronutrient variables, I instead included energy intake as a covariate in the next section (energy intake would be correlated with age, but should capture direct effects of how much people are eating better)

```{r}

covn <- "covdemo"

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std"
} else if (transform_choice == "int") {
  orm <- "lipids_int"
}

```

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "bmiz", "sex", "protein", "fats", "carbohydrate", "sugars", "cholesterol", "bristolstool", "dietPC1", "dietPC2", "dietPC3", "dietdiversity")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_", covn, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Covariates: demographic + batch + energy (for dietary macronutrient variables)

- for dietary macronutrient variables, I included energy intake as a covariate (would be correlated with age, but should capture direct effects of how much people are eating better)

```{r}

covn <- "covdemoenergy"

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std"
} else if (transform_choice == "int") {
  orm <- "lipids_int"
}

```

```{r}

pheno_name <- c("protein", "fats", "carbohydrate", "sugars", "cholesterol")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_", covn, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Covariates: demographic + batch + exclude storage outliers

- N.B. some variables (eg. diet) are unaffected, as they were not collected in the PathWest dataset anyway

```{r}

covn <- "covdemo_rmstorage"

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std"
} else if (transform_choice == "int") {
  orm <- "lipids_int"
}

```

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "bristolstool", "bmiz", "sex")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_", covn, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Covariates: demographic + batch, remove the storage outliers before INT

```{r}

covn <- "covdemo"

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std_rmstoragepre"
} else if (transform_choice == "int") {
  orm <- "lipids_int_rmstoragepre"
}

```

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "bristolstool", "bmiz")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_", covn, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = paste(covn, "rmstoragepre", sep = "_"), rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Covariates: demographic + batch + diet

- N.B. some variables (eg. diet) are unaffected, as they were not collected in the PathWest dataset anyway

```{r}

covn <- "covdemodiet"

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std"
} else if (transform_choice == "int") {
  orm <- "lipids_int"
}

```

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "bristolstool", "bmiz", "sex")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  if (pheno_ind == "asd") {
    orm <- "lipids_int_rmstoragepre"
  } else {
    orm <- "lipids_int"
  }
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_", covn, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Covariates: demographic + batch + collection time

- N.B. some variables (eg. diet) are unaffected, as they were not collected in the PathWest dataset anyway

```{r}

covn <- "covdemotime"

```

### Lipids

```{r}

if (transform_choice == "none") {
  orm <- "lipids"
} else if (transform_choice == "std") {
  orm <- "lipids_std"
} else if (transform_choice == "int") {
  orm <- "lipids_int"
}

```

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "bristolstool", "bmiz", "sex")
for (i in 1:length(pheno_name)) {
  pheno_ind <- pheno_name[i]
  if (pheno_ind == "asd") {
    orm <- "lipids_int_rmstoragepre"
  } else {
    orm <- "lipids_int"
  }
  rsq <- fread(paste(oreml_dir, "/", orm, "_", pheno_ind, "_", covn, "_reml.rsq", sep = ""), fill = TRUE)
  #print(rsq)
  
  # Collect the V(O)/Vp estimate
  tmp <- data.table(Data = orm, Pheno = pheno_ind, Cov = covn, rsq[which(rsq$Source == "V(O)/Vp"),], N = rsq$Variance[which(rsq$Source == "n")], P = rsq$Variance[which(rsq$Source == "Pval")], Vp = rsq$Variance[which(rsq$Source == "Vp")])
  oreml <- rbind(oreml, tmp)
}

```

## Display results

### Table

```{r}

datatable(oreml)

oreml_out <- oreml
colnames(oreml_out) <- c("Data", "Pheno", "Cov", "Source", "R2", "SE", "N", "P", "Variance_pheno")

# Write table
write.table(oreml_out, paste(oreml_dir, "/figures/", "oreml_lipidomics_raw.txt", sep = ""), col.names = T, row.names = F, sep = "\t", quote = F)

# Create adjusted p-value column
oreml$P_FDR <- p.adjust(oreml$P, method = "BH")
oreml$sig <- ifelse(oreml$P_FDR < 0.05, "Y", "N")

# Create new dataframe
oreml2 <- oreml

# Clean plots
oreml2$Variance <- oreml$Variance*100
oreml2$SE <- oreml$SE*100

# Change pheno names for better readiability
oreml2$Pheno[which(oreml2$Pheno == "asd")] <- "ASD"
oreml2$Pheno[which(oreml2$Pheno == "iqdq")] <- "IQ_DQ"
oreml2$Pheno[which(oreml2$Pheno == "sleep")] <- "sleep problems (CSHQ)"
oreml2$Pheno[which(oreml2$Pheno == "bristolstool")] <- "Bristol Stool Chart"
oreml2$Pheno[which(oreml2$Pheno == "tannergenital")] <- "Tanner (genital)"
oreml2$Pheno[which(oreml2$Pheno == "vabsms")] <- "motor (VABS)"
oreml2$Pheno[which(oreml2$Pheno == "bmiz")] <- "BMI (z-score)"

# Clean up analyses to display
oreml2 <- oreml2 %>% filter(Cov != "covdemo_rmstorage")
tmp <- oreml2 %>% filter(Data == "lipids_int_rmstoragepre") %>% filter(Cov == "covdemo_rmstoragepre") %>% filter(Pheno == "ASD") %>% mutate(Cov = "covdemo")
#tmp2 <- oreml2 %>% filter(Data == "lipids_int_rmstoragepre") %>% filter(Cov == "") %>% filter(Pheno == "ASD") %>% mutate(Cov = "nocov")
oreml2 <- oreml2 %>% filter(!oreml2$Cov == "covdemo_rmstoragepre")
oreml2 <- rbind(oreml2, tmp)
#oreml2 <- rbind(oreml2, tmp2)
oreml2 <- oreml2 %>% filter(!(Pheno == "ASD" & Data == "lipids_int" & Cov == "covdemo"))
oreml2 <- oreml2 %>% filter(!(Pheno == "ASD" & Data == "lipids_int" & Cov == ""))
oreml2$Cov[which(oreml2$Cov == "")] <- "nocov"
oreml2 <- oreml2 %>% filter(Data != "lipids_class_int")

# Update covdemo to covdemog to improve readability
oreml2$Cov <- gsub("covdemo", "covdemog", oreml2$Cov)

# Variables to help with ordering factors
uniq <- c("nocov", "covdemog", "covdemogdiet", "covdemogenergy", "covdemogtime")
oreml2$MatchCov <- match(oreml2$Cov, uniq)
pheno_order <- c("ASD", "IQ_DQ", "sleep problems (CSHQ)", "age", "Tanner (genital)", "BMI (z-score)", "sex", "motor (VABS)", "Bristol Stool Chart", "cholesterol", "protein", "fats", "sugars", "carbohydrates")
oreml2$MatchPheno <- match(oreml2$Pheno, pheno_order)
oreml2 <- oreml2 %>% mutate(Cov = fct_reorder(Cov, MatchCov)) %>% mutate(Pheno = fct_reorder(Pheno, MatchPheno))

# Create adjusted p-value column
oreml2$P_FDR <- p.adjust(oreml2$P, method = "BH")
oreml2$sig <- ifelse(oreml2$P_FDR < 0.05, "Y", "N")

# Write table
oreml2_out <- oreml2
colnames(oreml2_out)[which(colnames(oreml2) == "Variance")] <- "R2"
colnames(oreml2_out)[which(colnames(oreml2) == "Vp")] <- "Variance_pheno"
write.table(oreml2_out, paste(oreml_dir, "/figures/", "oreml_lipidomics.txt", sep = ""), col.names = T, row.names = F, sep = "\t", quote = F)

```

### Plot

#### ASD-related variables

```{r, fig.height = 6, fig.width = 8}

colour.tmp <- RColorBrewer::brewer.pal(4, "Dark2")

oreml2 %>% filter(!Pheno %in% c("cholesterol", "protein", "fats", "sugars", "carbohydrate", "dietPC1", "dietPC2", "dietPC3", "dietdiversity")) %>% mutate(Cov = fct_reorder(Cov, MatchCov)) %>% mutate(Pheno = fct_reorder(Pheno, MatchPheno)) %>% ggplot(aes(x=fct_rev(Cov), y=Variance, colour=Cov)) + 
    geom_hline(data = data.frame(yint=0.0), aes(yintercept = yint), colour = "grey60") +
    geom_errorbar(aes(ymin=Variance-SE, ymax=Variance+SE), width=.1, position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) +
    theme_bw() + theme(legend.position = "none") +
    #theme(axis.text.x = element_text(angle = 90)) +
    geom_text(aes(x=Cov, y=Variance, label=round(Variance,0)), vjust = 2, size = 3, colour = "black") +
    facet_wrap(~ factor(Pheno), ncol = 3) +
    coord_flip() +
    labs(x = "Covariates", y = expression("% of phenotypic variance explained"~(italic(R^2)))) +
    scale_color_manual(values = colour.tmp[1:4])

ggsave(paste(oreml_dir, "/figures/", "oreml_lipidomics_main.png", sep = ""), height = 7, width = 8)
ggsave(paste(oreml_dir, "/figures/", "oreml_lipidomics_main.svg", sep = ""), height = 7, width = 8)

```

#### Dietary variables

```{r, fig.height = 6, fig.width = 8}

oreml2 %>% filter(Pheno %in% c("cholesterol", "protein", "fats", "sugars", "carbohydrate", "dietPC1", "dietPC2", "dietPC3", "dietdiversity")) %>% mutate(Cov = fct_reorder(Cov, MatchCov)) %>% mutate(Pheno = fct_reorder(Pheno, MatchPheno)) %>% ggplot(aes(x=fct_rev(Cov), y=Variance, colour=Cov)) + 
    geom_hline(data = data.frame(yint=0.0), aes(yintercept = yint), colour = "grey60") +
    geom_errorbar(aes(ymin=Variance-SE, ymax=Variance+SE), width=.1, position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) +
    theme_bw() + theme(legend.position = "none") +
    #theme(axis.text.x = element_text(angle = 90)) +
    geom_text(aes(x=Cov, y=Variance, label=round(Variance,0)), vjust = 2.25, size = 3, colour = "black") +
    facet_wrap(~ factor(Pheno), ncol = 3) +
    coord_flip() +
    labs(x = "Covariates", y = expression("% of phenotypic variance explained"~(italic(R^2)))) +
    scale_color_manual(values = colour.tmp[c(1,2,4)])

ggsave(paste(oreml_dir, "/figures/", "oreml_lipidomics_diet.png", sep = ""), height = 8, width = 7)
ggsave(paste(oreml_dir, "/figures/", "oreml_lipidomics_diet.svg", sep = ""), height = 8, width = 7)

```

**Why ASD effect goes away when including storage_blood_days, but doesn't affect other variables**

```{r}

pheno_name <- c("asd", "age", "tannergenital", "sleep", "iqdq", "vabsms", "protein", "fats", "carbohydrate", "sugars", "cholesterol", "bristolstool", "bmiz")

tmp.qual <- pheno %>% melt(id.vars = c("IID", "storage_blood_days", "protein"), measure.vars = c("ASD", "tanner_genital"), value.name = "score", variable.name = "variable")
tmp.qual$score <- as.factor(tmp.qual$score)
tmp.qual$diet <- ifelse(is.na(tmp.qual$protein), "no", "yes")
tmp.quan <- pheno %>% melt(id.vars = c("IID", "storage_blood_days", "protein"), measure.vars = c("age", "sleep_cshq_total", "iq_dq_wisccomp_mselnv_nih", "vabs_ms_score", "protein", "bristol_stool_chart", "bmiz"), value.name = "score", variable.name = "variable")
tmp.quan$diet <- ifelse(is.na(tmp.quan$protein), "no", "yes")

tmp.qual %>% 
  mutate(variable = case_when(variable == "ASD" ~ "ASD",
                              variable == "tanner_genital" ~ "Tanner (genital)")) %>%
  ggplot(aes(x = score, y = storage_blood_days)) + 
  scale_colour_brewer(palette = "Dark2") + 
  geom_violin() + 
  geom_jitter(aes(colour = diet), alpha = 0.4) + 
  facet_wrap(~ variable, scales = "free_x")

tmp.quan %>%
  mutate(variable = case_when(variable == "age" ~ "age",
                              variable == "bmiz" ~ "BMI (z-score)",
                              variable == "sleep_cshq_total" ~ "Sleep problems (CSHQ)",
                              variable == "iq_dq_wisccomp_mselnv_nih" ~ "IQ/DQ",
                              variable == "vabs_ms_score" ~ "VABS (motor)",
                              variable == "protein" ~ "protein",
                              variable == "bristol_stool_chart" ~ "Bristol Stool Chart")) %>%
  ggplot(aes(x = score, y = storage_blood_days)) + 
  scale_colour_brewer(palette = "Dark2") + 
  geom_point(aes(colour = diet), alpha = 0.5) + 
  geom_smooth() + 
  facet_wrap(~ variable, scales = "free_x")

```

# Association results

### Analysis-specific munging

Some notes:

- All results are for the full n=825 lipids unless suggested otherwise (ie. lipids_class n=41 if mentioned explicitly)

```{r}

oreml_dir <- "/Volumes/YAPASD-Q0851/uqcyap3/ASD/Output/5_metabolomics/analysis/osca/assoc"

# %variance explained as effective N for multiple testing denominator
effN <- 0.95
effN <- 0.99

# Variable to store significant associations across traits
sig_all <- NULL
sig_all_adjclinical <- NULL

# Variable to store final model after backwards stepwise regression
model_out <- list()
model_out_lipids <- list()
model_out_adjclinical <- list()
model_out_lipids_adjclinical <- list()

```

### Calculate effective number of variables (for multiple testing correction)

```{r}

# Classes
lipids_class_int.pc <- prcomp(lipids_class_int[,c(2:ncol(lipids_class_int))], center = TRUE, scale = TRUE)
lipids_class_eigs <- (lipids_class_int.pc$sdev)^2
lipids_class_int.varpc.tmp <- lipids_class_eigs/sum(lipids_class_eigs)
lipids_class_int.varpc <- data.frame(var_pc = lipids_class_int.varpc.tmp, cumsum = cumsum(lipids_class_int.varpc.tmp))
lipids_class_int.effN <- length(which(lipids_class_int.varpc$cumsum < effN))
print(lipids_class_int.effN)
#lipids_class_int.effN <- length(which(lipids_class_int.varpc$cumsum < 0.95))
#print(lipids_class_int.effN)

# Species
lipids_int.pc <- prcomp(lipids_int[,c(2:ncol(lipids_int))], center = TRUE, scale = TRUE)
lipids_eigs <- (lipids_int.pc$sdev)^2
lipids_int.varpc.tmp <- lipids_eigs/sum(lipids_eigs)
lipids_int.varpc <- data.frame(var_pc = lipids_int.varpc.tmp, cumsum = cumsum(lipids_int.varpc.tmp))
lipids_int.effN <- length(which(lipids_int.varpc$cumsum < effN))
print(lipids_int.effN)
#lipids_int.effN <- length(which(lipids_int.varpc$cumsum < 0.95))
#print(lipids_int.effN)

```

### Annotation of pathways

```{r}

lsea_anno <- read.csv("/Users/uqcyap3/Documents/Research/ASD/Data/5_metabolomics/Baker/ids_gsea_ADNI.csv", header = F, as.is = T)
lsea_anno.ls <- split(lsea_anno, f = lsea_anno$V2)

lsea_total <- unlist(lapply(lsea_anno.ls, function(x) length(which(x != ""))))

```

## ASD

- https://hmdb.ca/metabolites/HMDB0011211
- https://pubchem.ncbi.nlm.nih.gov/compound/24779386

### Classes

**Logistic, no covariates, lipid classes**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_asd.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```
**Logistic, covariates, lipid classes and remove storage**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# Also make Manhattan plots of sig results

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("ASD", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Change OR to b
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "ASD", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(ASD ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "asd_lipids_class"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "ASD", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])

}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int[-which(lipids_class_int$IID %in% outliers_storage.id), which(colnames(lipids_class_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_rmstoragepre_asd_covdemo_effN0.95.logistic", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "asd"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) >= 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "ASD"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% 
  ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() +
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Logistic, covariates (including clinical lipids), lipid classes and remove storage**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_rmstoragepre_asd_covdemoclinical.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# Also make Manhattan plots of sig results

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("ASD", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Change OR to b
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "ASD", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(ASD ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "asd_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "ASD", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])

}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int[-which(lipids_class_int$IID %in% outliers_storage.id), which(colnames(lipids_class_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_rmstoragepre_asd_covdemoclinical.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_rmstoragepre_asd_covdemoclinical_effN0.95.logistic", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "asd"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) >= 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "ASD"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() +
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

### Species

**Logistic, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_asd.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

**Logistic, covariates, pre-remove storage outliers**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("ASD", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "ASD", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(ASD ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "asd_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "ASD", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int[-which(lipids_int$IID %in% outliers_storage.id), which(colnames(lipids_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemo_effN0.95.logistic", ".sigpca.rds", sep = ""))
}

# PCA loadings
loadings.long <- melt(sig.pca$rotation)
colnames(loadings.long) <- c("Lipid.species_header", "PC", "loadings")
loadings.long_anno <- inner_join(loadings.long, anno, by = "Lipid.species_header")
ggplot(loadings.long_anno, aes(x = PC, y = loadings, fill = Lipid.species)) + geom_bar(stat="identity", position=position_dodge()) + theme_bw()
ggsave(paste(oreml_dir, "/figures/lipids_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", ".sigpca.png", sep = ""), height = 5.5, width = 7)

```

```{r}

phenon <- "asd"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$MatchPoint[which(!is.na(assoc_anno$class_colour))] <- 3 #
assoc_anno$Trait <- "ASD"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>%
  ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
    geom_point(alpha = 0) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 1), aes(ymin = maxy, ymax = miny), colour = "gray92", position = position_jitter()) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 2), aes(ymin = maxy, ymax = miny), colour = "gray80", position = position_jitter()) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 3), aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Logistic, covariates (including clinical lipids), lipid classes and remove storage**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemoclinical.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# Also make Manhattan plots of sig results

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("ASD", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Change OR to b
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "ASD", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(ASD ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "asd_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "ASD", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])

}

```

```{r}

if (nrow(sig) >= 1) {
# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int[-which(lipids_int$IID %in% outliers_storage.id), which(colnames(lipids_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemoclinical.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemoclinical_effN0.95.logistic", ".sigpca.rds", sep = ""))
}
}

```

```{r}

phenon <- "asd"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) >= 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "ASD"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
    #geom_point() +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0, max.overlaps = 10) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Diet related? Check power drop when including dietary PCs**

- Testing dietary PC3 would not help to reveal whether these effects are due to diet, or whether they are due to dietary PCs(?)
- Is there some other statistical way to test for this difference while accounting for reduced power?

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemodiet.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

**Time of sample collection**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemotime.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "asd"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "ASD"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

## Age

### Classes

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_age.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_age_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("age", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "age", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(age ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "age_lipids_class"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "age", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_age_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_age_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}

```

```{r}

phenon <- "age"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "age"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_age_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("age", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "age", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(age ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "age_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "age", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_age_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_age_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}

```

```{r}

phenon <- "age"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "age"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

### Species

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("age", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "age", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(age ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "age_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "age", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}

```

```{r}

phenon <- "age"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$MatchPoint[which(!is.na(assoc_anno$class_colour))] <- 3 #
assoc_anno$Trait <- "age"

assoc_anno <- assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) 

assoc_anno %>%
    ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_point(alpha = 0) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 1), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray92", position = position_jitter()) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 2), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray80", position = position_jitter()) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 3), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0, max.overlaps = 10) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("age", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "age", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(age ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "age_lipids"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "age", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}

```

```{r}

phenon <- "age"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "age"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    #geom_point() +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0, max.overlaps = 10) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates including ASD**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates including collection time**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemotime.linear", sep = ""))
datatable(assoc %>% arrange(p))
```


- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "age"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "age"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

## Tanner

### Classes

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("tanner_genital", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "tanner_genital", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(tanner_genital ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "tanner_lipids_class"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "tanner_genital", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "tanner_genital"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "Tanner (genital)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("tanner_genital", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "tanner_genital", Data = "lipids_class", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(tanner_genital ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "tanner_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "tanner_genital", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_tannergenital_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "tanner_genital"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "Tanner (genital)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

### Species

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("tanner_genital", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "tanner_genital", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(tanner_genital ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "tanner_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "tanner_genital", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "tanner_genital"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$MatchPoint[which(!is.na(assoc_anno$class_colour))] <- 3 #
assoc_anno$Trait <- "Tanner (genital)"

assoc_anno <- assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) 

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>%
    ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_point(alpha = 0) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 1), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray92", position = position_jitter()) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 2), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray80", position = position_jitter()) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 3), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("tanner_genital", "sex", "participant_type", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "tanner_genital", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(tanner_genital ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "tanner_lipids"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "tanner_genital", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "tanner_genital"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "Tanner (genital)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates including collection time**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemotime.linear", sep = ""))
datatable(assoc %>% arrange(p))
```


- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "tanner_genital"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "Tanner (genital)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

## IQ/DQ

### Classes

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("iq_dq_wisccomp_mselnv_nih", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "IQ_DQ", Data = "lipids_class", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(iq_dq_wisccomp_mselnv_nih ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "iqdq_lipids_class"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "IQ_DQ", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

if (nrow(sig) >= 1) {
# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}
}

```

```{r}

phenon <- "iqdq"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot ##### none are significant, so change class_colour
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "IQ_DQ"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

```{r}
sig <- assoc %>% arrange(p) %>% filter(p < 0.05/lipids_class_int.effN) %>% pull(Probe)
if (length(sig) > 0) {
if (length(sig) <= 25) {
  plot.gg <- ggplot(lipids_class.long %>% filter(lipid %in% all_of(sig)), aes(x = iq_dq_wisccomp_mselnv_nih, y = pmol_mL)) + 
    scale_colour_brewer(palette="Dark2") + 
    geom_point() + geom_smooth(method = "lm") +
    facet_wrap(~ Lipid.species, scales = "free_y") +
    theme(legend.position = "none")
} else if (length(sig > 25)) {
  sig <- sig[1:25] # already ordered
  plot.gg <- ggplot(lipids_class.long %>% filter(lipid %in% all_of(sig)), aes(x = iq_dq_wisccomp_mselnv_nih, y = pmol_mL)) + 
    scale_colour_brewer(palette="Dark2") + 
    geom_point() + geom_smooth(method = "lm") +
    facet_wrap(~ Lipid.species, scales = "free_y") +
    theme(legend.position = "none")
}
plot.gg
}
```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("iq_dq_wisccomp_mselnv_nih", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "IQ_DQ", Data = "lipids_class", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(iq_dq_wisccomp_mselnv_nih ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "iqdq_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "IQ_DQ", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

if (nrow(sig) >= 1) {
# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_iqdq_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
}

```

```{r}

phenon <- "iqdq"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) >= 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot ##### none are significant, so change class_colour
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "IQ_DQ"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

### Species

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("iq_dq_wisccomp_mselnv_nih", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "IQ_DQ", Data = "lipids", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(iq_dq_wisccomp_mselnv_nih ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "iqdq_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "IQ_DQ", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}

# PCA loadings
loadings.long <- melt(sig.pca$rotation)
colnames(loadings.long) <- c("Lipid.species_header", "PC", "loadings")
loadings.long_anno <- inner_join(loadings.long, anno, by = "Lipid.species_header")
ggplot(loadings.long_anno, aes(x = PC, y = loadings, fill = Lipid.species)) + geom_bar(stat="identity", position=position_dodge()) + theme_bw()
ggsave(paste(oreml_dir, "/figures/lipids_", transform_choice, "_iqdq_covdemo.linear", ".sigpca.png", sep = ""), height = 5.5, width = 7)

```

```{r}

phenon <- "iqdq"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$MatchPoint[which(!is.na(assoc_anno$class_colour))] <- 3 ##assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "IQ_DQ"

assoc_anno <- assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder))

assoc_anno %>% mutate(point = fct_reorder(point, MatchPoint)) %>% 
  ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 1), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray92", position = position_jitter()) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 2), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray80", position = position_jitter()) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 3), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), position = position_jitter()) +    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("iq_dq_wisccomp_mselnv_nih", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "IQ_DQ", Data = "lipids", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(iq_dq_wisccomp_mselnv_nih ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "iqdq_lipids"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "IQ_DQ", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "iqdq"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "IQ_DQ"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates including collection time**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemotime.linear", sep = ""))
datatable(assoc %>% arrange(p))
```


- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "iqdq"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "IQ_DQ"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

## Sleep (CSHQ)

### Classes

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("sleep_cshq_total", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "sleep_problems", Data = "lipids_class", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(sleep_cshq_total ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "sleep_lipids_class"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "sleep_problems", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "sleep"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "sleep problems (CSHQ)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

#ggsave(paste("/Users/uqcyap3/Documents/Research/ASD/Write-up/Manuscripts/AAB_Metabolomics/Figures_and_Tables/", phenon, "_", datan, "_forest.png", sep = ""), height = 8, width = 4)
if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("sleep_cshq_total", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "sleep_problems", Data = "lipids_class", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(sleep_cshq_total ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "sleep_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "sleep_problems", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_sleep_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "sleep"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/lipids_class_int.effN, assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "sleep problems (CSHQ)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

#ggsave(paste("/Users/uqcyap3/Documents/Research/ASD/Write-up/Manuscripts/AAB_Metabolomics/Figures_and_Tables/", phenon, "_", datan, "_forest.png", sep = ""), height = 8, width = 4)
if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

### Species

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("sleep_cshq_total", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "sleep_problems", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(sleep_cshq_total ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "tanner_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "sleep_problems", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}

# PCA loadings
loadings.long <- melt(sig.pca$rotation)
colnames(loadings.long) <- c("Lipid.species_header", "PC", "loadings")
loadings.long_anno <- inner_join(loadings.long, anno, by = "Lipid.species_header")
ggplot(loadings.long_anno %>% filter(PC %in% paste("PC", 1:10, sep = "")), aes(x = PC, y = loadings, fill = Lipid.species)) + geom_bar(stat="identity", position=position_dodge()) + theme_bw()
ggsave(paste(oreml_dir, "/figures/lipids_", transform_choice, "_sleep_covdemo.linear", ".sigpca.png", sep = ""), height = 5.5, width = 7)

```

```{r}

phenon <- "sleep_cshq_total"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$MatchPoint[which(!is.na(assoc_anno$class_colour))] <- 3 #
assoc_anno$Trait <- "sleep problems (CSHQ)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% 
    ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_point(alpha = 0) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 1), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray92", position = position_jitter()) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 2), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), colour = "gray80", position = position_jitter()) +
    geom_pointrange(data = subset(assoc_anno, MatchPoint == 3), aes(x = fct_rev(Lipid.class), ymin = maxy, ymax = miny), position = position_jitter()) +    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0, max.overlaps = 10) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

#ggsave(paste("/Users/uqcyap3/Documents/Research/ASD/Write-up/Manuscripts/AAB_Metabolomics/Figures_and_Tables/", phenon, "_", datan, "_forest.png", sep = ""), height = 8, width = 4)
if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("sleep_cshq_total", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "sleep_problems", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(sleep_cshq_total ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "tanner_lipids"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "sleep_problems", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "sleep_cshq_total"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "sleep problems (CSHQ)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0, max.overlaps = 10) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

#ggsave(paste("/Users/uqcyap3/Documents/Research/ASD/Write-up/Manuscripts/AAB_Metabolomics/Figures_and_Tables/", phenon, "_", datan, "_forest.png", sep = ""), height = 8, width = 4)
if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates including collection time**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemotime.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "sleep_cshq_total"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "sleep problems (CSHQ)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

## BMI z-score

### Classes

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("bmiz", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "BMI (z-score)", Data = "lipids_class", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(bmiz ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "bmiz_lipids_class"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "BMI (z-score)", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

if (nrow(sig) >= 1) {
# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}
}

```

```{r}

phenon <- "bmiz"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot ##### none are significant, so change class_colour
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "BMI (z-score)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

```{r}
sig <- assoc %>% arrange(p) %>% filter(p < 0.05/lipids_class_int.effN) %>% pull(Probe)
if (length(sig) > 0) {
if (length(sig) <= 25) {
  plot.gg <- ggplot(lipids_class.long %>% filter(lipid %in% all_of(sig)), aes(x = bmiz, y = pmol_mL)) + 
    scale_colour_brewer(palette="Dark2") + 
    geom_point() + geom_smooth(method = "lm") +
    facet_wrap(~ Lipid.species, scales = "free_y") +
    theme(legend.position = "none")
} else if (length(sig > 25)) {
  sig <- sig[1:25] # already ordered
  plot.gg <- ggplot(lipids_class.long %>% filter(lipid %in% all_of(sig)), aes(x = bmiz, y = pmol_mL)) + 
    scale_colour_brewer(palette="Dark2") + 
    geom_point() + geom_smooth(method = "lm") +
    facet_wrap(~ Lipid.species, scales = "free_y") +
    theme(legend.position = "none")
}
plot.gg
}
```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_class_int.effN),]
phenocol <- c("bmiz", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "BMI (z-score)", Data = "lipids_class", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids_class %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(bmiz ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "bmiz_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "BMI (z-score)", Data = "lipids_class", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

if (nrow(sig) >= 1) {
# Generate PCs of the top variables
sig.pca <- prcomp(lipids_class_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_class_", transform_choice, "_bmiz_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
}

```

```{r}

phenon <- "bmiz"
datan <- "lipids_class_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) >= 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot ##### none are significant, so change class_colour
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "BMI (z-score)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

### Species

**Linear, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

**Linear, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemo.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("bmiz", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "BMI (z-score)", Data = "lipids", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(bmiz ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "bmiz_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "BMI (z-score)", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemo.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemo_effN0.95.linear", ".sigpca.rds", sep = ""))
}

```

```{r}

phenon <- "bmiz"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$MatchPoint[which(!is.na(assoc_anno$class_colour))] <- 3 #
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "BMI (z-score)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% 
  ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
    geom_point(alpha = 0) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 1), aes(ymin = maxy, ymax = miny), colour = "gray92", position = position_jitter()) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 2), aes(ymin = maxy, ymax = miny), colour = "gray80", position = position_jitter()) +
    geom_pointrange(data = S4Vectors::subset(assoc_anno, MatchPoint == 3), aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates (including clinical lipids)**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemoclinical.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("bmiz", "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "BMI (z-score)", Data = "lipids", sig))
  
  # Backwards stepwise regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(bmiz ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "bmiz_lipids"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "BMI (z-score)", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int %>% dplyr::select(all_of(sig$Probe)))
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemoclinical.linear", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemoclinical_effN0.95.linear", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "bmiz"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "sex", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "BMI (z-score)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Linear, covariates including collection time**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemotime.linear", sep = ""))
datatable(assoc %>% arrange(p))
```

- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "bmiz"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$b + assoc_anno$se
assoc_anno$miny <- assoc_anno$b - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "BMI (z-score)"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = b, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 0), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```


## Sex

### Species

**Logistic, no covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sex.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("sex", "age", "age2", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "sex", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(as.numeric(sex) ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "sex_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "sex", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int[-which(lipids_int$IID %in% outliers_storage.id), which(colnames(lipids_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemo.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemo_effN0.95.logistic", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "sex"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "sex"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```


**Logistic, covariates**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemo.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("sex", "age", "age2", "storage_blood_days", "Batch", "InjectionOrder")
datatable(sig)

if (nrow(sig) >= 1) {
  
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all <- rbind(sig_all, data.frame(Pheno = "sex", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(as.numeric(sex) ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "sex_lipids"
  model_out[[length(model_out) + 1]] <- model_out.tmp
  model_out_lipids[[length(model_out_lipids) + 1]] <- data.frame(Pheno = "sex", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])
    
}

```

```{r}

# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int[-which(lipids_int$IID %in% outliers_storage.id), which(colnames(lipids_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemo.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemo_effN0.95.logistic", ".sigpca.rds", sep = ""))
}
```

```{r}

phenon <- "sex"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) > 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.class, NA)
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "sex"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Logistic, covariates (including clinical lipids), lipid classes and remove storage**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemoclinical.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

```{r}

# Backwards stepwise regression: http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/

# Also make Manhattan plots of sig results

# library(MASS)

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]
phenocol <- c("sex", "age", "age2", "storage_blood_days", "Batch", "InjectionOrder", "cholesterol_lipidome", "triglycerides_lipidome")
datatable(sig)

if (nrow(sig) >= 1) {
  
  # Change OR to b
  colnames(sig)[which(colnames(sig) == "OR")] <- "b"
  
  # Keep the Bonferroni sig
  sig_all_adjclinical <- rbind(sig_all_adjclinical, data.frame(Pheno = "sex", Data = "lipids", sig))
  
  # Backwards stepwsie regression
  tmp.lipid <- lipids %>% dplyr::select("IID", all_of(sig$Probe))
  tmp.pheno <- pheno %>% filter(IID %in% tmp.lipid$IID) %>% dplyr::select("IID", all_of(phenocol))
  tmp.in <- inner_join(tmp.pheno, tmp.lipid, by = "IID") %>% dplyr::select(-"IID")
  
  # Full model
  full.model <- lm(as.numeric(sex) ~., data = tmp.in)
  # Stepwise regression model
  step.model <- stepAIC(full.model, direction = "backward", 
                      trace = FALSE)
  print(summary(step.model))
  
  model_out.tmp <- list(colnames(data.frame(step.model$model)))
  names(model_out.tmp) <- "sex_lipids_class"
  model_out_adjclinical[[length(model_out_adjclinical) + 1]] <- model_out.tmp
  model_out_lipids_adjclinical[[length(model_out_lipids_adjclinical) + 1]] <- data.frame(Pheno = "sex", Data = "lipids", Probe = model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenocol))])

}

```

```{r}

if (nrow(sig) >= 1) {
# Generate PCs of the top variables
sig.pca <- prcomp(lipids_int[-which(lipids_int$IID %in% outliers_storage.id), which(colnames(lipids_int) %in% sig$Probe)])
varpc <- (sig.pca$sdev)^2/sum((sig.pca$sdev)^2)
sig.varpc <- data.frame(varpc = varpc, cumsum = cumsum(varpc))
datatable(sig.varpc %>% mutate_if(is.numeric, ~signif(., 3)))

if (effN == 0.99) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemoclinical.logistic", ".sigpca.rds", sep = ""))
} else if (effN == 0.95) {
  saveRDS(sig.pca, paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemoclinical_effN0.95.logistic", ".sigpca.rds", sep = ""))
}
}

```

```{r}

phenon <- "sex"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Add labels for the top hits
if (nrow(sig) >= 1) {
  bsr_keep <- model_out.tmp[[1]][-which(model_out.tmp[[1]] %in% c(phenon, "age", "age2", "storage_blood_days", "Batch", "InjectionOrder"))]
  assoc_anno$Hit <- ifelse(assoc_anno$Lipid.species_header %in% bsr_keep, assoc_anno$Lipid.species, NA)
} else {
  assoc_anno$Hit <- NA
}

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
#assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05, assoc_anno$Lipid.class, NA)
assoc_anno$Trait <- "sex"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, label = Hit, shape = point)) +
    #geom_point() +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    geom_text_repel(size = 2.5, force = 5, colour = "black", min.segment.length = 0, max.overlaps = 10) +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_clinicallipids_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

**Time of sample collection**

```{r}
assoc <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sex_covdemotime.logistic", sep = ""))
datatable(assoc %>% arrange(p))
```

- don't bother with the labels - just colours for significant

```{r}

sig <- assoc[which(assoc$p < 0.05/lipids_int.effN),]

phenon <- "sex"
datan <- "lipids_int"
if (datan == "lipids_class_int") {
  anno.tmp <- anno_class
} else if (datan == "lipids_int") {
  anno.tmp <- anno
}

# Munge for plot
assoc$Lipid.species_header <- assoc$Probe

assoc_anno <- inner_join(assoc, anno.tmp, by = "Lipid.species_header")

# Forest plot
assoc_anno$MatchOrder <- match(assoc_anno$Lipid.class, anno.tmp$Lipid.class)
assoc_anno$point <- ifelse(assoc_anno$p < 0.05, "open", "filled")
assoc_anno$MatchPoint <- match(assoc_anno$point, c("filled", "open"))
assoc_anno$maxy <- assoc_anno$OR + assoc_anno$se
assoc_anno$miny <- assoc_anno$OR - assoc_anno$se
assoc_anno$class_colour <- ifelse(assoc_anno$p < 0.05/lipids_int.effN, assoc_anno$Lipid.class, NA)
#assoc_anno$bonf <- ifelse(assoc_anno$p < 0.05/nrow(assoc_anno), assoc_anno$Lipid.species, NA)
assoc_anno$Trait <- "sex"

assoc_anno %>% mutate(Lipid.class = fct_reorder(Lipid.class, MatchOrder)) %>% mutate(point = fct_reorder(point, MatchPoint)) %>% ggplot(aes(x = fct_rev(Lipid.class), y = OR, colour = class_colour, shape = point)) +
#    geom_pointrange(aes(ymin = maxy, ymax = miny)) +
    geom_pointrange(aes(ymin = maxy, ymax = miny), position = position_jitter()) +
    geom_hline(aes(yintercept = 1), linetype = "dotted", colour = "navy") +
    scale_shape_manual(values = c(1, 16)) +
    scale_colour_discrete(na.value = "grey80") +
    theme_bw() + theme(legend.position = "none") +
    xlab("Lipid class") +
    coord_flip() + 
    facet_wrap(~ Trait)

if (effN == 0.99) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
} else if (effN == 0.95) {
  ggsave(paste(oreml_dir, "/figures/", phenon, "_", datan, "_covdemotime_effN0.95_forest_bsrmodel.png", sep = ""), height = 8, width = 4)
}

```

# Collect outputs for downstream use

```{r}

if (effN == 0.99) {
  
print("Number of hits per analysis")
sig_all %>% group_by(Pheno, Data) %>% dplyr::summarise(n=n())
print("Number of hits per analysis, adjusting for clinical lipids")
sig_all_adjclinical %>% group_by(Pheno, Data) %>% dplyr::summarise(n=n())

# Look for overlap between analyses
tmp <- unique(sig_all$Pheno)
for (i in 1:length(unique(sig_all$Pheno))) {
  ind <- tmp[i]
  print(ind)
  sig_all.tmp <- sig_all %>% filter(Pheno == ind) %>% mutate(type = "covdemo")
  sig_all_adjclinical.tmp <- sig_all_adjclinical %>% filter(Pheno == ind) %>% mutate(type = "covdemoclinical")
  sig_all_adjclinical.tmp %>% group_by(type, Data) %>% dplyr::summarise(n=n(), overlap_original = length(which(Probe %in% sig_all.tmp$Probe))) %>% print()
}

}

```

```{r}

effn <- ifelse(effN == 0.99, "", "_effN0.95")

fwrite(sig_all, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_sig_aggregated", effn, ".txt", sep = ""), col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(sig_all_adjclinical, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_adjclinical_sig_aggregated", effn, ".txt", sep = ""), col.names = T, row.names = F, quote = F, sep = "\t")

saveRDS(model_out, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_bsrmodel_aggregated", effn, ".rds", sep = ""))
saveRDS(model_out_adjclinical, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_bsrmodel_adjclinical_aggregated", effn, ".rds", sep = ""))

saveRDS(model_out_lipids, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_bsrmodel_lipids_aggregated", effn, ".rds", sep = ""))
saveRDS(model_out_lipids_adjclinical, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_bsrmodel_lipids_adjclinical_aggregated", effn, ".rds", sep = ""))

# Output table of BSR terms
model_out_lipids.df <- rbindlist(model_out_lipids)
model_out_lipids_sig_all <- inner_join(model_out_lipids.df, sig_all)
colnames(model_out_lipids_sig_all)[which(colnames(model_out_lipids_sig_all) == "b")] <- "Effect"

model_out_lipids_adjcliincal.df <- rbindlist(model_out_lipids_adjclinical)
model_out_lipids_sig_all_adjclinical <- inner_join(model_out_lipids_adjcliincal.df, sig_all_adjclinical)
colnames(model_out_lipids_sig_all_adjclinical)[which(colnames(model_out_lipids_sig_all_adjclinical) == "b")] <- "Effect"

# Add annotation column
anno_full <- full_join(anno[,c("Lipid.species", "Lipid.species_header")], anno_class[,c("Lipid.species", "Lipid.species_header")])
colnames(anno_full)[which(colnames(anno_full) == "Lipid.species_header")] <- "Probe"
colnames(anno_full)[which(colnames(anno_full) == "Lipid.species")] <- "Lipid.name"

model_out_lipids_sig_all_out <- left_join(model_out_lipids_sig_all, anno_full) %>% dplyr::select(-c("Chr", "bp", "Gene", "Orientation"))
datatable(model_out_lipids_sig_all_out)
model_out_lipids_sig_all_out_adjclinical <- left_join(model_out_lipids_sig_all_adjclinical, anno_full) %>% dplyr::select(-c("Chr", "bp", "Gene", "Orientation"))
datatable(model_out_lipids_sig_all_out_adjclinical)

fwrite(model_out_lipids_sig_all_out, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_bsrmodel_lipids_aggregated_sumstats", effn, ".txt", sep = ""), col.names = T, row.names = F, quote = F, sep = "\t")
fwrite(model_out_lipids_sig_all_out_adjclinical, paste("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_bsrmodel_lipids_adjclinical_aggregated_sumstats", effn, ".txt", sep = ""), col.names = T, row.names = F, quote = F, sep = "\t")

```

# Heatmap of LWAS lipids

```{r}

if (effN == 0.99) {
library(ComplexHeatmap)

sig_all <- read.delim("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/osca_assoc_sig_aggregated.txt", header = T, as.is = T)

sig_species_neurodev <- sig_all %>% filter(Data == "lipids") %>% 
  filter(Pheno %in% c("ASD", "IQ_DQ", "sleep_problems")) %>%
  mutate(Pheno = ifelse(Pheno == "sleep_problems", "sleep", Pheno))

lipids_sig_species_neurodev <- lipids %>% 
  dplyr::select(c("IID", all_of(sig_species_neurodev$Probe))) %>% 
  inner_join(pheno %>% dplyr::select(c("IID", "age", "sex", "bmiz", "ASD", "iq_dq_wisccomp_mselnv_nih", "sleep_cshq_total")), ., by = "IID") %>%
  mutate(ASD = as.factor(ASD)) %>%
  mutate(iq_dq_wisccomp_mselnv_nih = ifelse(is.na(iq_dq_wisccomp_mselnv_nih), 0, iq_dq_wisccomp_mselnv_nih)) %>%
  mutate(sleep_cshq_total = ifelse(is.na(sleep_cshq_total), 0, sleep_cshq_total))

lipids_hm <- as.matrix(lipids_sig_species_neurodev[,c(sig_species_neurodev$Probe)])
lipids_hm <- t(apply(lipids_hm, 2, function(x) (x-mean(x))/sd(x)))

ha <- HeatmapAnnotation(age = lipids_sig_species_neurodev$age, 
                        sex = lipids_sig_species_neurodev$sex, 
                        bmiz = lipids_sig_species_neurodev$bmiz,
                        ASD = lipids_sig_species_neurodev$ASD, 
                        IQ_DQ = lipids_sig_species_neurodev$iq_dq_wisccomp_mselnv_nih, 
                        sleep = lipids_sig_species_neurodev$sleep_cshq_total)

row_ha <- rowAnnotation(LWAS = sig_species_neurodev$Pheno)

png("~/Documents/Research/ASD/Output/5_metabolomics/analysis/osca/assoc/figures/osca_assoc_sig_neurodev_heatmap.png", height = 600, width = 800)
Heatmap(lipids_hm, name = "mat", top_annotation = ha, right_annotation = row_ha, cluster_rows = TRUE, show_row_names = FALSE, show_column_names = FALSE)
dev.off()

}

```

# Compare LWAS sensitivity analyses

## +/- adj clinical lipids

```{r}

if (effN == 0.99) {
  
assoc_asd <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_asd_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemoclinical.logistic", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_asd_adjclin)[which(colnames(assoc_asd_adjclin) == "p")] <- "p_adjclinical"
assoc_asd.tmp <- data.frame(inner_join(assoc_asd, assoc_asd_adjclin, by = "Probe"), Pheno = "ASD")

assoc_iqdq <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_iqdq_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemoclinical.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_iqdq_adjclin)[which(colnames(assoc_iqdq_adjclin) == "p")] <- "p_adjclinical"
assoc_iqdq.tmp <- data.frame(inner_join(assoc_iqdq, assoc_iqdq_adjclin, by = "Probe"), Pheno = "IQ/DQ")

assoc_sleep <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_sleep_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemoclinical.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_sleep_adjclin)[which(colnames(assoc_sleep_adjclin) == "p")] <- "p_adjclinical"
assoc_sleep.tmp <- data.frame(inner_join(assoc_sleep, assoc_sleep_adjclin, by = "Probe"), Pheno = "sleep problems")

assoc_age <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_age_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemoclinical.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_age_adjclin)[which(colnames(assoc_age_adjclin) == "p")] <- "p_adjclinical"
assoc_age.tmp <- data.frame(inner_join(assoc_age, assoc_age_adjclin, by = "Probe"), Pheno = "age")

assoc_tanner <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_tanner_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemoclinical.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_tanner_adjclin)[which(colnames(assoc_tanner_adjclin) == "p")] <- "p_adjclinical"
assoc_tanner.tmp <- data.frame(inner_join(assoc_tanner, assoc_tanner_adjclin, by = "Probe"), Pheno = "Tanner (genital)")

assoc_bmiz <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_bmiz_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemoclinical.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_bmiz_adjclin)[which(colnames(assoc_bmiz_adjclin) == "p")] <- "p_adjclinical"
assoc_bmiz.tmp <- data.frame(inner_join(assoc_bmiz, assoc_bmiz_adjclin, by = "Probe"), Pheno = "BMI (z-score)")

assoc.tmp <- rbind(assoc_asd.tmp, assoc_iqdq.tmp, assoc_sleep.tmp, assoc_age.tmp, assoc_tanner.tmp, assoc_bmiz.tmp)

colnames(assoc.tmp) <- c("Probe", "p_covdemo", "p_covdemoclinical", "Pheno")

assoc.tmp$Lipid.species_header <- assoc.tmp$Probe
assoc.tmp <- inner_join(assoc.tmp, anno, by = "Lipid.species_header")
assoc.tmp$label <- ifelse(assoc.tmp$p_covdemo > (0.05/302) & assoc.tmp$p_covdemoclinical <= (0.05/302), assoc.tmp$Lipid.species, NA)

ggplot(assoc.tmp, aes(x = -log10(p_covdemo), y = -log10(p_covdemoclinical), label = label)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_vline(xintercept = -log10(0.05/302), colour = "red") +
  geom_hline(yintercept = -log10(0.05/302), colour = "gold") +
  geom_label_repel(size = 2, force = 5, colour = "black", min.segment.length = 0) +
  facet_wrap(~ Pheno, scales = "free", ncol = 1)

ggsave(paste(oreml_dir, "/figures/lwas_p_covdemo_v_covdemoclinical.png", sep = ""), height = 12, width = 8)
}

```

## +/- collection time of day

```{r}

if (effN == 0.99) {

assoc_asd <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemo.logistic", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_asd_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_rmstoragepre_asd_covdemotime.logistic", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_asd_adjclin)[which(colnames(assoc_asd_adjclin) == "p")] <- "p_adjtime"
assoc_asd.tmp <- data.frame(inner_join(assoc_asd, assoc_asd_adjclin, by = "Probe"), Pheno = "ASD")

assoc_iqdq <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_iqdq_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_iqdq_covdemotime.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_iqdq_adjclin)[which(colnames(assoc_iqdq_adjclin) == "p")] <- "p_adjtime"
assoc_iqdq.tmp <- data.frame(inner_join(assoc_iqdq, assoc_iqdq_adjclin, by = "Probe"), Pheno = "IQ/DQ")

assoc_sleep <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_sleep_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_sleep_covdemotime.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_sleep_adjclin)[which(colnames(assoc_sleep_adjclin) == "p")] <- "p_adjtime"
assoc_sleep.tmp <- data.frame(inner_join(assoc_sleep, assoc_sleep_adjclin, by = "Probe"), Pheno = "sleep problems")

assoc_age <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_age_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_age_covdemotime.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_age_adjclin)[which(colnames(assoc_age_adjclin) == "p")] <- "p_adjtime"
assoc_age.tmp <- data.frame(inner_join(assoc_age, assoc_age_adjclin, by = "Probe"), Pheno = "age")

assoc_tanner <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_tanner_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_tannergenital_covdemotime.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_tanner_adjclin)[which(colnames(assoc_tanner_adjclin) == "p")] <- "p_adjtime"
assoc_tanner.tmp <- data.frame(inner_join(assoc_tanner, assoc_tanner_adjclin, by = "Probe"), Pheno = "Tanner (genital)")

assoc_bmiz <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemo.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
assoc_bmiz_adjclin <- fread(paste(oreml_dir, "/lipids_", transform_choice, "_bmiz_covdemotime.linear", sep = "")) %>% dplyr::select(c("Probe", "p"))
colnames(assoc_bmiz_adjclin)[which(colnames(assoc_bmiz_adjclin) == "p")] <- "p_adjtime"
assoc_bmiz.tmp <- data.frame(inner_join(assoc_bmiz, assoc_bmiz_adjclin, by = "Probe"), Pheno = "BMI (z-score)")

assoc.tmp <- rbind(assoc_asd.tmp, assoc_iqdq.tmp, assoc_sleep.tmp, assoc_age.tmp, assoc_tanner.tmp, assoc_bmiz.tmp)

colnames(assoc.tmp) <- c("Probe", "p_covdemo", "p_covdemotime", "Pheno")

assoc.tmp$Lipid.species_header <- assoc.tmp$Probe
assoc.tmp <- inner_join(assoc.tmp, anno, by = "Lipid.species_header")
assoc.tmp$label <- ifelse((assoc.tmp$p_covdemo > (0.05/302) & assoc.tmp$p_covdemotime <= (0.05/302)) | (assoc.tmp$p_covdemo <= (0.05/302) & assoc.tmp$p_covdemotime > (0.05/302)), assoc.tmp$Lipid.species, NA)

ggplot(assoc.tmp, aes(x = -log10(p_covdemo), y = -log10(p_covdemotime), label = label)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_vline(xintercept = -log10(0.05/302), colour = "red") +
  geom_hline(yintercept = -log10(0.05/302), colour = "gold") +
  geom_label_repel(size = 2, force = 5, colour = "black", min.segment.length = 0) +
  facet_wrap(~ Pheno, scales = "free", ncol = 1)

ggsave(paste(oreml_dir, "/figures/lwas_p_covdemo_v_covdemotime.png", sep = ""), height = 12, width = 8)

}

```